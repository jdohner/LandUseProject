% bioboxtwo.m
%
% functionality of bioboxtwo_sub10 & subN combined into one script
%
% July 26, 2018
% Julia Dohner


function [C1dt,C2dt,delCdt,delC1,delC2] = bioboxtwo(epsilon,Q1a,Q2a,ts,year,...
    dpCO2a,T,gamma,fert_i,photResp_i)

load ff

T0 = T(1,2);
dt = 1/ts;

% Define box sizes in ppm

Catm = 600/2.12; % around 283 ppm (preindustrial)
C1 = 110/2.12; % fast biosphere box, from old model
C2 = 1477/2.12; % slow biosphere box, changed to be same as 1 box

% Rate constants
K1a = 1/2.5; 
Ka1 = K1a*C1/Catm;
K2a = 1/60; % slow box to atmosphere
Ka2 = K2a*C2/Catm;

% set up arrays
delC1 = [year(:,1) zeros(size(year))];
delC2 = [year(:,1) zeros(size(year))];
delCdt(:,1) = year;
C1dt(:,1) = year;
C2dt(:,1) = year;
delC1(length(year)+1,1) = year(length(year),1)+dt;
delC2(length(year)+1,1) = year(length(year),1)+dt;

a = find(ff(:,1) == year(1));

for ii = 1:length(year)
    % fast box (equation (3) in Rafelski 2009
    % calculate land uptake by fast box

    % nonlinear
    % need log of current co2 / preindustrial - load co2a and co2_preind as
    % vars

    % T-dependent respiration
    if photResp_i == 1
        % fast box
        C1dt(ii,2) = Ka1*(Catm + epsilon*dpCO2a(ii,2) + gamma*ff(ii+a-1,2)*Catm) - ...
        K1a*Q1a^((T(ii,2)-T0)/10)*(C1 + delC1(ii,2)); 

        % slow box (equation (3) in Rafelski 2009
        C2dt(ii,2) = Ka2*(Catm + epsilon*dpCO2a(ii,2)+ gamma*ff(ii+a-1,2)*Catm) - ...
        K2a*Q2a^((T(ii,2)-T0)/10)*(C2 + delC2(ii,2)); 

    elseif photResp_i == 2
        %T-dependent photosynthesis
        C1dt(ii,2) = Ka1*(Catm + epsilon*dpCO2a(ii,2)+ gamma*ff(ii+a-1,2)*Catm)...
            *(1 + Q1a*(T(ii,2)-T0)) - K1a*(C1 + delC1(ii,2));
        % - K1a*Q1a^((T(ii,2)-T0)/10)*(C1 + delC1(ii,2)); 

      
        C2dt(ii,2) = Ka2*(Catm + epsilon*dpCO2a(ii,2)+ gamma*ff(ii+a-1,2)*Catm)...
            *(1 + Q2a*(T(ii,2)-T0)) -  K2a*(C2 + delC2(ii,2)); 
        % - K2a*Q2a^((T(ii,2)-T0)/10)*(C2 + delC2(ii,2)); 

    end
    
    % box total change in concentrations (of fast, slow box, respectively)
    delC1(ii+1,2) = sum(C1dt(:,2))*dt;
    delC2(ii+1,2) = sum(C2dt(:,2))*dt;

    % total flux into land    
    delCdt(ii,2) = C2dt(ii,2) + C1dt(ii,2);

end


    
end


